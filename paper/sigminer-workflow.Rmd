---
title: "Signature Analysis Workflows with sigminer"
subtitle: "A clear illustration"
author: ["Shixiang Wang", "Tao Wu", "Ziyu Tao", "Xue-Song Liu"]
institute: "ShanghaiTech University"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: vignette
    toc: true
---

```{r init, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  tidy = TRUE, 
  warning = FALSE, message = FALSE
)
```


This vignette uses a TCGA breast mutation dataset to show how to quickly start analyzing [mutational signatures](https://cancer.sanger.ac.uk/cosmic/signatures) with [{sigminer}](https://cran.r-project.org/web/packages/sigminer/index.html).


## Data Import and Preprocessing

The input data should be in [MAF format](https://docs.gdc.cancer.gov/Data/File_Formats/MAF_Format/), it can be either a MAF file or a `data.frame` in R.
Here, we use `{TCGAbiolinks}` package to download TCGA BRCA MAF file as a `data.frame`.

```{r, eval=FALSE}
library(TCGAbiolinks)

maf <- GDCquery_Maf("BRCA", pipelines = "mutect2")
save(maf, file = "maf.RData")
```

Then you can transform the data to `MAF` object with `read_maf()`.

```{r}
library(sigminer)

load("maf.RData")
maf = read_maf(maf)
maf
```

Next, you need to choose which type of mutational signature you want to analyze, all [COSMIC signatures](https://cancer.sanger.ac.uk/cosmic/signatures) (i.e. SBS, DBS and INDEL) are available.

By calling `sig_tally()` with the following options, you can generate all sample matrices supported by `{sigminer}`.

```{r}
# Set mode to 'SBS' for SBS only.
# Set mode to 'DBS' for DBS only.
# Set mode to 'ID' for INDEL only.
# Set mode to 'ALL' for all types of mutational signatures.
maf_tally <- sig_tally(
  maf,
  mode = "ALL",
  ref_genome = "BSgenome.Hsapiens.UCSC.hg38",
  genome_build = "hg38",
  use_syn = TRUE, 
  add_trans_bias = TRUE
)
```

For a middle-size dataset, this step takes less than 1 minutes.

See the matrix list:

```{r}
str(maf_tally, max.level = 1)
```

> Most of mutation catalogues defined by [`{sigProfiler}`](https://osf.io/s93d5/wiki/home/) are implemented by `{sigminer}`

You can also directly use standard sample matrices generated by other tools (like `{sigProfiler}`) or 
from elsewhere (like a published paper). Just make sure the data are loaded
as `matrix` before doing the following analyses.

Now, you can take a look at the catalogues of this breast cancer dataset, e.g. typical 96 lego matrix for SBS mutation:

```{r, fig.width=12, fig.height=3}
show_catalogue(maf_tally$SBS_96 %>% t(), style = "cosmic")
```

You can also specify a single sample:

```{r, fig.width=12, fig.height=3}
show_catalogue(maf_tally$SBS_96 %>% t(), style = "cosmic", 
               samples = "TCGA-5L-AAT1-01A-12D-A41F-09", samples_name = "TCGA-5L-AAT1")
```

## Workflow 1: *de novo* Signatures Discovery

## Workflow 2: Reference Signatures Fitting

## Session

```{r}
devtools::session_info()
```

## Contact

- Xue-Song Liu: <liuxs@shanghaitech.edu.cn>
- Shixiang Wang: <wangshx@shanghaitech.edu.cn>