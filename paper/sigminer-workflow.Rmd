---
title: "Signature Analysis Workflows with sigminer"
subtitle: "A clear illustration"
author: ["Shixiang Wang", "Tao Wu", "Ziyu Tao", "Xue-Song Liu"]
institute: "ShanghaiTech University"
date: "`r Sys.Date()`"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: vignette
    toc: true
---

```{r init, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  tidy = TRUE, 
  warning = FALSE, message = FALSE
)
```


This vignette uses a TCGA breast mutation dataset to show how to quickly start analyzing [mutational signatures](https://cancer.sanger.ac.uk/cosmic/signatures) with [{sigminer}](https://cran.r-project.org/web/packages/sigminer/index.html).


## Data Import and Preprocessing

The input data should be in [MAF format](https://docs.gdc.cancer.gov/Data/File_Formats/MAF_Format/), it can be either a MAF file or a `data.frame` in R.
Here, we use `{TCGAbiolinks}` package to download TCGA BRCA MAF file as a `data.frame`.

```{r, eval=FALSE}
library(TCGAbiolinks)

maf <- GDCquery_Maf("BRCA", pipelines = "mutect2")
save(maf, file = "maf.RData")
```

Then you can transform the data to `MAF` object with `read_maf()`.

```{r}
library(sigminer)

load("maf.RData")
maf = read_maf(maf)
maf
```

Next, you need to choose which type of mutational signature you want to analyze, all [COSMIC signatures](https://cancer.sanger.ac.uk/cosmic/signatures) (i.e. SBS, DBS and INDEL) are available.

By calling `sig_tally()` with the following options, you can generate all sample matrices supported by `{sigminer}`.

```{r}
# Set mode to 'SBS' for SBS only.
# Set mode to 'DBS' for DBS only.
# Set mode to 'ID' for INDEL only.
# Set mode to 'ALL' for all types of mutational signatures.
maf_tally <- sig_tally(
  maf,
  mode = "ALL",
  ref_genome = "BSgenome.Hsapiens.UCSC.hg38",
  genome_build = "hg38",
  use_syn = TRUE, 
  add_trans_bias = TRUE
)
```

For a middle-size dataset, this step takes less than 1 minutes.

See the matrix list:

```{r}
str(maf_tally, max.level = 1)
```

You can also directly use standard sample matrices generated by other tools (like `{sigProfiler}`) or 
from elsewhere (like a published paper). Just make sure the data are loaded
as `matrix` before doing the following analyses.

Now, you can take a look at the catalogues of this breast cancer dataset, e.g. typical 96 lego matrix for SBS mutation:

```{r, fig.width=12, fig.height=3}
show_catalogue(maf_tally$SBS_96 %>% t(), style = "cosmic")
```

```{r, fig.width=12, fig.height=3}
show_catalogue(maf_tally$DBS_78 %>% t(), style = "cosmic", mode = "DBS")
```

```{r, fig.width=12, fig.height=3}
show_catalogue(maf_tally$ID_83 %>% t(), style = "cosmic", mode = "ID")
```

You can also specify a single sample:

```{r, fig.width=12, fig.height=3}
show_catalogue(maf_tally$SBS_96 %>% t(), style = "cosmic", 
               samples = "TCGA-5L-AAT1-01A-12D-A41F-09", samples_name = "TCGA-5L-AAT1")
```

## Workflow 1: *de novo* Signatures Discovery

*De novo* signatures discovery can be applied to datasets with abundant mutations. 

```{r}
# SBS
sum(maf_tally$SBS_96)
# DBS
sum(maf_tally$DBS_78)
# INDEL
sum(maf_tally$ID_83)
```

Here we can see that TCGA breast cancers have plents of SBS mutations, we will use SBS as an example, same analysis can be used for DBS and INDEL.


```{r, message=TRUE}
sigs_sbs <- sig_auto_extract(maf_tally$SBS_96, nrun = 10, cores = parallel::detectCores(),
                             destdir = "bayesianNMF", result_prefix = "sbs",
                             recover = TRUE)
# recover = TRUE is used to use stored results
```

The `sig_auto_extract()` uses Bayesian NMF to extract mutational signatures through the automatic relevance determination technique (*Kim, Jaegil, et al. "Somatic ERCC2 mutations are associated with a distinct genomic signature in urothelial tumors." Nature genetics 48.6 (2016): 600.*). 

You can also extract specified number of signatures with `sig_extract()`, it use standard NMF algorithms provided by R package [{NMF}](https://cran.r-project.org/web/packages/NMF/index.html) (default is "brunet"). In this way, you need to estimate a proper signature number based on some measures, e.g. cophenetic. You can get measures by running NMF for a range of signature numbers, this is implemented as `sig_estimate()`.

Once you get the signatures, you can show the signature profile with


```{r, fig.width=12, fig.height=5}
show_sig_profile(sigs_sbs, mode = "SBS", style = "cosmic")
```

Based on COSMIC reference signatures, you can run `get_sig_similarity()` to get the cosine similarity between discovered signatures and COSMIC signatures.

```{r, message=TRUE}
sim <- get_sig_similarity(sigs_sbs, sig_db = "SBS")
```

The result returns the best match COSMIC signatures and their etiologies.

This result can be go further plotted by pheatmap.

```{r, fig.width=12}
pheatmap::pheatmap(sim$similarity, cluster_cols = F, cluster_rows = F)
```

## Workflow 2: Reference Signatures Fitting

This workflow serves 2 situations:

1. In clinical practice, there are only a few tumor samples or even one tumor sample. You want to get the signature exposures (to judge if a signature exists or to quantify the signature contribution) based on known mutational signatures either from COSMIC database or custom decomposition like workflow 1.
2. You want to optimize signature exposures for signatures defined by workflow 1.

This workflow is implemented as `sig_fit()` (i.e. signature fitting) in `{sigminer}`.

### Single sample

If you only have one sample, you can still use `matrix` format as input. Here we use 30 [COSMIC V2 signatures](https://cancer.sanger.ac.uk/cosmic/signatures_v2) as reference signatures.

```{r}
one_sample <- sig_fit(catalogue_matrix = maf_tally$SBS_96["TCGA-5L-AAT1-01A-12D-A41F-09", , drop = FALSE] %>% t(), 
        sig_index = 1:30,
        sig_db = "legacy")
one_sample
```

If you set a threshold, you can determine if a signature exists in this sample.

```{r}
one_sample[one_sample > 0, ]
```

In this situation, relative signature exposures may be more suitable.

```{r}
one_sample_rel <- sig_fit(catalogue_matrix = maf_tally$SBS_96["TCGA-5L-AAT1-01A-12D-A41F-09", , drop = FALSE] %>% t(), 
        sig_index = 1:30,
        sig_db = "legacy",
        type = "relative")
one_sample_rel
```

A typical cutoff should be set to 0.01 or 0.05.

```{r}
one_sample_rel[one_sample_rel > 0.05, ]
```


### Multiple samples

Same usage for multiple samples, here we show head 5 samples.

```{r}
mul_sample <- sig_fit(catalogue_matrix = maf_tally$SBS_96[1:5, ] %>% t(), 
        sig_index = 1:30,
        sig_db = "legacy")
mul_sample
```

Same analysis can be applied to DBS and INDEL. This dataset also has plents of INDELs, you can take a try.

Firstly check valid COSMIC INDEL signature indices if you are not familiar with.

```{r}
show_cosmic_sig_profile(sig_db = "ID")
```

```{r}
mul_sample_id <- sig_fit(catalogue_matrix = maf_tally$ID_83[1:4, ] %>% t(), 
        sig_index = 1:11,
        sig_db = "ID")
mul_sample_id
```

If you want to optimize exposures for signatures obtained from workflow 1, run the following command.

```{r}
mul_sample_custom <- sig_fit(catalogue_matrix = maf_tally$SBS_96[1:5, ] %>% t(), 
                             sig = sigs_sbs)
mul_sample_custom
```



## Session

```{r}
devtools::session_info()
```

## Contact

- Xue-Song Liu: <liuxs@shanghaitech.edu.cn>
- Shixiang Wang: <wangshx@shanghaitech.edu.cn>